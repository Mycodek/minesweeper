<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Probability Minesweeper</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Bomb / board hit animations */
        @keyframes bomb-hit {
            0% {
                transform: scale(1);
                background-color: #fecaca;
            }

            30% {
                transform: scale(1.2);
                background-color: #f87171;
            }

            60% {
                transform: scale(0.9);
                background-color: #b91c1c;
            }

            100% {
                transform: scale(1);
                background-color: #fee2e2;
            }
        }

        @keyframes board-shake {
            0% {
                transform: translateX(0);
            }

            20% {
                transform: translateX(-6px);
            }

            40% {
                transform: translateX(6px);
            }

            60% {
                transform: translateX(-4px);
            }

            80% {
                transform: translateX(4px);
            }

            100% {
                transform: translateX(0);
            }
        }

        .bomb-hit {
            animation: bomb-hit 500ms ease-out forwards;
        }

        .board-shake {
            animation: board-shake 500ms ease-out;
        }

        /* Board-local glass crack overlay */
        @keyframes crack-appear {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }

            40% {
                opacity: 0.85;
                transform: scale(1.03);
            }

            100% {
                opacity: 0;
                transform: scale(1);
            }
        }

        .crack-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0;
            background-image:
                /* main diagonal crack */
                linear-gradient(135deg,
                    rgba(255, 255, 255, 0.98) 0,
                    rgba(255, 255, 255, 0.98) 3px,
                    transparent 3px),
                /* secondary diagonal */
                linear-gradient(225deg,
                    rgba(255, 255, 255, 0.9) 0,
                    rgba(255, 255, 255, 0.9) 3px,
                    transparent 3px),
                /* vertical split */
                linear-gradient(180deg,
                    rgba(255, 255, 255, 0.9) 0,
                    rgba(255, 255, 255, 0.9) 3px,
                    transparent 3px);
            background-size: 100% 100%, 100% 100%, 3px 100%;
            background-position: center center, center center, center center;
            mix-blend-mode: screen;
            filter: drop-shadow(0 0 6px rgba(15, 15, 15, 0.9));
            z-index: 10;
        }

        .crack-overlay.active {
            animation: crack-appear 650ms ease-out;
        }

        /* Dark theme color tweaks: strict neutral gray/black, no blue */
        html.dark .bg-gray-900 {
            background-color: #050505 !important;
        }

        html.dark .bg-gray-800 {
            background-color: #111111 !important;
        }

        html.dark .bg-gray-700 {
            background-color: #1a1a1a !important;
        }

        html.dark .bg-gray-600 {
            background-color: #262626 !important;
        }

        html.dark .bg-gray-400 {
            background-color: #404040 !important;
        }

        html.dark .text-gray-200 {
            color: #e5e5e5 !important;
        }

        html.dark .text-gray-300 {
            color: #d4d4d4 !important;
        }

        /* Game over overlay */
        @keyframes game-over-pop {
            0% {
                transform: translateY(40px) scale(0.6);
                opacity: 0;
                text-shadow: 0 0 0 rgba(0, 0, 0, 0.8);
            }

            60% {
                transform: translateY(0) scale(1.1);
                opacity: 1;
                text-shadow:
                    0 6px 0 rgba(0, 0, 0, 0.9),
                    0 12px 25px rgba(0, 0, 0, 0.9);
            }

            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
                text-shadow:
                    0 4px 0 rgba(0, 0, 0, 0.9),
                    0 10px 20px rgba(0, 0, 0, 0.9);
            }
        }

        .game-over-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center,
                    rgba(0, 0, 0, 0.6) 0,
                    rgba(0, 0, 0, 0.9) 65%);
            opacity: 0;
            pointer-events: none;
            transition: opacity 250ms ease-out;
            z-index: 50;
        }

        .game-over-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .game-over-text {
            font-size: clamp(3rem, 10vw, 5rem);
            font-weight: 800;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: #fef2f2;
            text-align: center;
            animation: game-over-pop 700ms ease-out both;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-200 flex flex-col min-h-screen">

    <header class="p-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <h1 class="text-xl font-bold">Probability Minesweeper</h1>

        <div class="flex flex-col gap-2 w-full md:w-auto md:flex-row md:flex-wrap md:items-center md:justify-end">
            <!-- Row 1: timer + bombs + theme toggle -->
            <div class="flex items-center justify-between gap-3 w-full md:w-auto md:justify-end md:gap-4">
                <div class="flex items-center gap-3">
                    <span id="timer" class="font-mono">00:00</span>
                    <span id="bombCounter" class="font-mono">0/0</span>
                </div>

                <div class="flex items-center gap-2 select-none">
                    <span class="text-xs font-semibold text-gray-700 dark:text-gray-300">Day</span>
                    <button id="themeToggle" type="button" role="switch" aria-checked="false"
                        class="relative inline-flex h-7 w-14 items-center rounded-full bg-gray-300 dark:bg-gray-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-gray-400 dark:focus:ring-gray-500">
                        <span id="themeToggleThumb"
                            class="inline-block h-6 w-6 transform rounded-full bg-white shadow transition-transform duration-300 translate-x-1"></span>
                    </button>
                    <span class="text-xs font-semibold text-gray-700 dark:text-gray-300">Night</span>
                </div>
            </div>

            <!-- Row 2: rows/cols + difficulty (centered on mobile) -->
            <div class="flex flex-wrap items-center justify-center gap-3 w-full md:w-auto md:justify-end">
                <input id="rowsInput" type="number" min="5" max="50" value="20"
                    class="w-16 p-1 border rounded bg-gray-200 dark:bg-gray-700" />

                <input id="colsInput" type="number" min="5" max="50" value="20"
                    class="w-16 p-1 border rounded bg-gray-200 dark:bg-gray-700" />

                <select id="complexitySelect" class="p-1 border rounded bg-gray-200 dark:bg-gray-700">
                    <option value="0.1">Easy</option>
                    <option value="0.15" selected>Medium</option>
                    <option value="0.2">Hard</option>
                </select>
            </div>

            <!-- Row 3: size presets (full width on mobile) -->
            <div id="sizePresets"
                class="flex w-full justify-between text-xs font-semibold md:w-auto md:justify-end md:gap-2">
                <button type="button" data-size="10"
                    class="flex-1 mx-0.5 px-2 py-1 rounded border border-gray-400 dark:border-gray-600 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 md:flex-none">
                    n10
                </button>
                <button type="button" data-size="20"
                    class="flex-1 mx-0.5 px-2 py-1 rounded border border-gray-400 dark:border-gray-600 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 md:flex-none">
                    n20
                </button>
                <button type="button" data-size="30"
                    class="flex-1 mx-0.5 px-2 py-1 rounded border border-gray-400 dark:border-gray-600 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 md:flex-none">
                    n30
                </button>
                <button type="button" data-size="50"
                    class="flex-1 mx-0.5 px-2 py-1 rounded border border-gray-400 dark:border-gray-600 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 md:flex-none">
                    n50
                </button>
            </div>

            <!-- Row 4: actions (Reset left, Restart right on mobile) -->
            <div class="flex w-full justify-between md:w-auto md:justify-end md:gap-2">
                <button id="resetBtn" type="button"
                    class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded">
                    Reset
                </button>

                <button id="restartBtn" type="button"
                    class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded">
                    Restart
                </button>
            </div>
        </div>
    </header>

    <div id="message" class="text-center text-sm text-red-500 h-6"></div>

    <main class="flex-1 overflow-auto p-3 flex justify-center">
        <div id="gameWrapper" class="relative inline-block">
            <div id="game" class="grid gap-1 bg-gray-300 dark:bg-gray-800 p-2 rounded shadow-md">
                Loading board...
            </div>
            <div id="crackOverlay" class="crack-overlay"></div>
        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            let ROWS = 20;
            let COLS = 20;
            let BOMB_PROB = 0.15;

            let board = [];
            let totalBombs = 0;
            let revealedCount = 0;
            let flagsCount = 0;
            let totalSafe = 0;
            let gameOver = false;
            // Defaults that can adapt based on screen size
            let defaultRows = 20;
            let defaultCols = 20;
            const DEFAULT_BOMB_PROB = 0.15; // Medium

            let timerInterval = null;
            let seconds = 0;

            function updateTimer() {
                const m = String(Math.floor(seconds / 60)).padStart(2, '0');
                const s = String(seconds % 60).padStart(2, '0');
                document.getElementById('timer').textContent = `${m}:${s}`;
            }

            function startTimer() {
                if (timerInterval) return;
                timerInterval = setInterval(() => {
                    seconds++;
                    updateTimer();
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            function resetTimer() {
                stopTimer();
                seconds = 0;
                updateTimer();
            }

            function detectInitialBoardSize() {
                // Treat small screens as mobile; use smaller board there.
                const isMobile = window.matchMedia && window.matchMedia("(max-width: 640px)").matches;
                return isMobile ? 10 : 20;
            }

            function updateBombCounter() {
                document.getElementById('bombCounter').textContent =
                    `${totalBombs - flagsCount}/${totalBombs}`;
            }

            function inBounds(r, c) {
                return r >= 0 && r < ROWS && c >= 0 && c < COLS;
            }

            function countAdjacent(r, c) {
                let count = 0;
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        if (dr === 0 && dc === 0) continue;
                        const nr = r + dr;
                        const nc = c + dc;
                        if (inBounds(nr, nc) && board[nr][nc].bomb) count++;
                    }
                }
                return count;
            }

            function renderBoard() {
                const game = document.getElementById('game');
                game.innerHTML = "";
                game.style.gridTemplateColumns = `repeat(${COLS}, 30px)`;
                // Ensure the container grows to the full grid size so its background
                // covers the entire board even when it overflows and scrolls.
                game.style.width = "max-content";
                game.style.gridAutoRows = "30px";

                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {

                        const cell = document.createElement("div");
                        cell.className =
                            "w-[30px] h-[30px] flex items-center justify-center text-sm font-bold cursor-pointer bg-gray-400 dark:bg-gray-600";
                        cell.dataset.row = r;
                        cell.dataset.col = c;

                        cell.addEventListener("click", onClick);
                        cell.addEventListener("contextmenu", onRightClick);

                        game.appendChild(cell);
                    }
                }
            }

            function revealAllBombs() {
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        const cell = board[r][c];
                        if (!cell.bomb) continue;

                        const el = document.querySelector(`[data-row='${r}'][data-col='${c}']`);
                        if (!el) continue;

                        el.textContent = "ðŸ’£";
                        el.className =
                            `w-[30px] h-[30px] flex items-center justify-center text-sm font-bold bg-red-200 dark:bg-red-900 cursor-default ${cell.flagged ? "ring-2 ring-yellow-400" : ""}`;
                    }
                }
            }

            function reveal(r, c) {
                const cell = board[r][c];
                if (cell.revealed || cell.flagged) return;

                const el = document.querySelector(`[data-row='${r}'][data-col='${c}']`);
                cell.revealed = true;
                revealedCount++;

                el.className =
                    "w-[30px] h-[30px] flex items-center justify-center text-sm font-bold bg-gray-200 dark:bg-gray-800 cursor-default";

                if (cell.bomb) {
                    el.textContent = "ðŸ’£";
                } else if (cell.adjacent > 0) {
                    el.textContent = cell.adjacent;
                }

                if (!cell.bomb && cell.adjacent === 0) {
                    for (let dr = -1; dr <= 1; dr++) {
                        for (let dc = -1; dc <= 1; dc++) {
                            const nr = r + dr;
                            const nc = c + dc;
                            if (inBounds(nr, nc)) reveal(nr, nc);
                        }
                    }
                }
            }

            function onClick(e) {
                if (gameOver) return;

                const r = +e.target.dataset.row;
                const c = +e.target.dataset.col;
                const cell = board[r][c];

                if (!timerInterval) startTimer();

                if (cell.bomb) {
                    reveal(r, c);
                    revealAllBombs();

                    const hitCell = document.querySelector(`[data-row='${r}'][data-col='${c}']`);
                    if (hitCell) {
                        hitCell.classList.add("bomb-hit");
                    }

                    const gameEl = document.getElementById("game");
                    if (gameEl) {
                        gameEl.classList.add("board-shake");
                        setTimeout(() => {
                            gameEl.classList.remove("board-shake");
                        }, 500);
                    }

                    const crackOverlay = document.getElementById("crackOverlay");
                    if (crackOverlay) {
                        crackOverlay.classList.remove("active");
                        // Force reflow so animation can restart on subsequent games
                        void crackOverlay.offsetWidth;
                        crackOverlay.classList.add("active");
                    }

                    gameOver = true;
                    stopTimer();
                    showEndOverlay("Game Over");
                    return;
                }

                reveal(r, c);

                if (revealedCount === totalSafe) {
                    gameOver = true;
                    stopTimer();
                    document.getElementById("message").textContent = "You Win!";
                }
            }

            function onRightClick(e) {
                e.preventDefault();
                if (gameOver) return;

                const r = +e.target.dataset.row;
                const c = +e.target.dataset.col;
                const cell = board[r][c];
                if (cell.revealed) return;

                cell.flagged = !cell.flagged;
                e.target.textContent = cell.flagged ? "ðŸš©" : "";
                flagsCount += cell.flagged ? 1 : -1;
                updateBombCounter();
            }

            function initGame() {

                ROWS = +document.getElementById('rowsInput').value;
                COLS = +document.getElementById('colsInput').value;
                BOMB_PROB = parseFloat(document.getElementById('complexitySelect').value);

                board = [];
                totalBombs = 0;
                revealedCount = 0;
                flagsCount = 0;
                gameOver = false;
                resetTimer();
                document.getElementById("message").textContent = "";
                const overlay = document.getElementById("gameOverOverlay");
                if (overlay) {
                    overlay.classList.remove("visible");
                }

                for (let r = 0; r < ROWS; r++) {
                    const row = [];
                    for (let c = 0; c < COLS; c++) {
                        const bomb = Math.random() < BOMB_PROB;
                        if (bomb) totalBombs++;
                        row.push({ bomb, revealed: false, flagged: false, adjacent: 0 });
                    }
                    board.push(row);
                }

                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        if (!board[r][c].bomb) {
                            board[r][c].adjacent = countAdjacent(r, c);
                        }
                    }
                }

                totalSafe = ROWS * COLS - totalBombs;
                updateBombCounter();
                renderBoard();

            }

            function showEndOverlay(text) {
                const overlay = document.getElementById("gameOverOverlay");
                if (!overlay) return;
                const textEl = overlay.querySelector(".game-over-text");
                if (textEl && text) {
                    textEl.textContent = text;
                }
                overlay.classList.remove("visible");
                // restart animation if already shown before
                void overlay.offsetWidth;
                overlay.classList.add("visible");
            }

            function applySizePreset(size, shouldInit = true) {
                const rowsInput = document.getElementById('rowsInput');
                const colsInput = document.getElementById('colsInput');
                if (!rowsInput || !colsInput) return;

                rowsInput.value = String(size);
                colsInput.value = String(size);

                const presets = document.getElementById('sizePresets');
                if (presets) {
                    presets.querySelectorAll("[data-size]").forEach(btn => {
                        const btnSize = parseInt(btn.getAttribute("data-size"), 10);
                        const isActive = btnSize === size;
                        btn.classList.toggle("bg-gray-700", isActive);
                        btn.classList.toggle("text-white", isActive);
                        btn.classList.toggle("dark:bg-gray-200", isActive);
                        btn.classList.toggle("dark:text-black", isActive);
                    });
                }

                if (shouldInit) {
                    initGame();
                }
            }

            function resetToDefaults() {
                document.getElementById('complexitySelect').value = String(DEFAULT_BOMB_PROB);
                // Re-apply the detected default size preset (n10 on mobile, n20 on desktop)
                applySizePreset(defaultRows, true);
            }

            function setTheme(theme) {
                const isDark = theme === "dark";
                if (isDark) {
                    document.documentElement.classList.add("dark");
                } else {
                    document.documentElement.classList.remove("dark");
                }
                localStorage.setItem("theme", theme);

                const toggle = document.getElementById("themeToggle");
                const thumb = document.getElementById("themeToggleThumb");
                if (toggle && thumb) {
                    toggle.setAttribute("aria-checked", String(isDark));
                    thumb.classList.toggle("translate-x-1", !isDark);
                    thumb.classList.toggle("translate-x-7", isDark);
                }
            }

            function toggleTheme() {
                const isDark = document.documentElement.classList.contains("dark");
                setTheme(isDark ? "light" : "dark");
            }

            const restartBtn = document.getElementById("restartBtn");
            if (restartBtn) {
                restartBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    initGame();
                });
            }

            const resetBtn = document.getElementById("resetBtn");
            if (resetBtn) {
                resetBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    resetToDefaults();
                });
            }

            const sizePresets = document.getElementById("sizePresets");
            if (sizePresets) {
                sizePresets.querySelectorAll("[data-size]").forEach(btn => {
                    btn.addEventListener("click", (e) => {
                        e.preventDefault();
                        const size = parseInt(btn.getAttribute("data-size"), 10);
                        if (!Number.isNaN(size)) {
                            applySizePreset(size, true);
                        }
                    });
                });
            }

            const gameOverOverlay = document.getElementById("gameOverOverlay");
            if (gameOverOverlay) {
                gameOverOverlay.addEventListener("click", () => {
                    gameOverOverlay.classList.remove("visible");
                    const msg = document.getElementById("message");
                    if (msg) {
                        msg.textContent = "Game Over";
                    }
                });
            }

            const themeToggle = document.getElementById("themeToggle");
            if (themeToggle) {
                themeToggle.addEventListener("click", (e) => {
                    e.preventDefault();
                    toggleTheme();
                });
            }

            // Determine default board size based on screen and apply the matching preset.
            defaultRows = defaultCols = detectInitialBoardSize();
            applySizePreset(defaultRows, false);

            setTheme(localStorage.getItem("theme") || "dark");
            initGame();

        });
    </script>
    <div id="gameOverOverlay" class="game-over-overlay">
        <div class="game-over-text">Game Over</div>
    </div>
</body>

</html>
