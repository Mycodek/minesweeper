<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Probability Minesweeper</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Bomb / board hit animations */
        @keyframes bomb-hit {
            0% {
                transform: scale(1);
                background-color: #fecaca;
            }

            30% {
                transform: scale(1.2);
                background-color: #f87171;
            }

            60% {
                transform: scale(0.9);
                background-color: #b91c1c;
            }

            100% {
                transform: scale(1);
                background-color: #fee2e2;
            }
        }

        @keyframes board-shake {
            0% {
                transform: translateX(0);
            }

            20% {
                transform: translateX(-6px);
            }

            40% {
                transform: translateX(6px);
            }

            60% {
                transform: translateX(-4px);
            }

            80% {
                transform: translateX(4px);
            }

            100% {
                transform: translateX(0);
            }
        }

        .bomb-hit {
            animation: bomb-hit 500ms ease-out forwards;
        }

        .board-shake {
            animation: board-shake 500ms ease-out;
        }

        /* Board-local glass crack overlay */
        @keyframes crack-appear {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }

            40% {
                opacity: 0.85;
                transform: scale(1.03);
            }

            100% {
                opacity: 0;
                transform: scale(1);
            }
        }

        .crack-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0;
            background-image:
                /* main diagonal crack */
                linear-gradient(135deg,
                    rgba(255, 255, 255, 0.98) 0,
                    rgba(255, 255, 255, 0.98) 3px,
                    transparent 3px),
                /* secondary diagonal */
                linear-gradient(225deg,
                    rgba(255, 255, 255, 0.9) 0,
                    rgba(255, 255, 255, 0.9) 3px,
                    transparent 3px),
                /* vertical split */
                linear-gradient(180deg,
                    rgba(255, 255, 255, 0.9) 0,
                    rgba(255, 255, 255, 0.9) 3px,
                    transparent 3px);
            background-size: 100% 100%, 100% 100%, 3px 100%;
            background-position: center center, center center, center center;
            mix-blend-mode: screen;
            filter: drop-shadow(0 0 6px rgba(15, 15, 15, 0.9));
            z-index: 10;
        }

        .crack-overlay.active {
            animation: crack-appear 650ms ease-out;
        }

        /* Dark theme color tweaks: strict neutral gray/black, no blue */
        html.dark .bg-gray-900 {
            background-color: #050505 !important;
        }

        html.dark .bg-gray-800 {
            background-color: #111111 !important;
        }

        html.dark .bg-gray-700 {
            background-color: #1a1a1a !important;
        }

        html.dark .bg-gray-600 {
            background-color: #262626 !important;
        }

        html.dark .bg-gray-400 {
            background-color: #404040 !important;
        }

        html.dark .text-gray-200 {
            color: #e5e5e5 !important;
        }

        html.dark .text-gray-300 {
            color: #d4d4d4 !important;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-200 flex flex-col min-h-screen">

    <header class="p-4 flex flex-wrap items-center justify-between gap-3">
        <h1 class="text-xl font-bold">Probability Minesweeper</h1>

        <div class="flex flex-wrap gap-3 items-center">

            <span id="timer" class="font-mono">00:00</span>
            <span id="bombCounter" class="font-mono">0/0</span>

            <input id="rowsInput" type="number" min="5" max="50" value="20"
                class="w-16 p-1 border rounded bg-gray-200 dark:bg-gray-700" />

            <input id="colsInput" type="number" min="5" max="50" value="20"
                class="w-16 p-1 border rounded bg-gray-200 dark:bg-gray-700" />

            <select id="complexitySelect" class="p-1 border rounded bg-gray-200 dark:bg-gray-700">
                <option value="0.1">Easy</option>
                <option value="0.15" selected>Medium</option>
                <option value="0.2">Hard</option>
            </select>

            <button id="restartBtn" type="button"
                class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded">
                Restart
            </button>

            <button id="resetBtn" type="button"
                class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded">
                Reset
            </button>

            <div class="flex items-center gap-2 select-none">
                <span class="text-xs font-semibold text-gray-700 dark:text-gray-300">Day</span>
                <button id="themeToggle" type="button" role="switch" aria-checked="false"
                    class="relative inline-flex h-7 w-14 items-center rounded-full bg-gray-300 dark:bg-gray-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-gray-400 dark:focus:ring-gray-500">
                    <span id="themeToggleThumb"
                        class="inline-block h-6 w-6 transform rounded-full bg-white shadow transition-transform duration-300 translate-x-1"></span>
                </button>
                <span class="text-xs font-semibold text-gray-700 dark:text-gray-300">Night</span>
            </div>

        </div>
    </header>

    <div id="message" class="text-center text-sm text-red-500 h-6"></div>

    <main class="flex-1 overflow-auto p-3 flex justify-center">
        <div id="gameWrapper" class="relative inline-block">
            <div id="game" class="grid gap-1 bg-gray-300 dark:bg-gray-800 p-2 rounded shadow-md">
                Loading board...
            </div>
            <div id="crackOverlay" class="crack-overlay"></div>
        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            let ROWS = 20;
            let COLS = 20;
            let BOMB_PROB = 0.15;

            let board = [];
            let totalBombs = 0;
            let revealedCount = 0;
            let flagsCount = 0;
            let totalSafe = 0;
            let gameOver = false;
            const DEFAULT_ROWS = 20;
            const DEFAULT_COLS = 20;
            const DEFAULT_BOMB_PROB = 0.15; // Medium

            let timerInterval = null;
            let seconds = 0;

            function updateTimer() {
                const m = String(Math.floor(seconds / 60)).padStart(2, '0');
                const s = String(seconds % 60).padStart(2, '0');
                document.getElementById('timer').textContent = `${m}:${s}`;
            }

            function startTimer() {
                if (timerInterval) return;
                timerInterval = setInterval(() => {
                    seconds++;
                    updateTimer();
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            function resetTimer() {
                stopTimer();
                seconds = 0;
                updateTimer();
            }

            function updateBombCounter() {
                document.getElementById('bombCounter').textContent =
                    `${totalBombs - flagsCount}/${totalBombs}`;
            }

            function inBounds(r, c) {
                return r >= 0 && r < ROWS && c >= 0 && c < COLS;
            }

            function countAdjacent(r, c) {
                let count = 0;
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        if (dr === 0 && dc === 0) continue;
                        const nr = r + dr;
                        const nc = c + dc;
                        if (inBounds(nr, nc) && board[nr][nc].bomb) count++;
                    }
                }
                return count;
            }

            function renderBoard() {
                const game = document.getElementById('game');
                game.innerHTML = "";
                game.style.gridTemplateColumns = `repeat(${COLS}, 30px)`;
                // Ensure the container grows to the full grid size so its background
                // covers the entire board even when it overflows and scrolls.
                game.style.width = "max-content";
                game.style.gridAutoRows = "30px";

                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {

                        const cell = document.createElement("div");
                        cell.className =
                            "w-[30px] h-[30px] flex items-center justify-center text-sm font-bold cursor-pointer bg-gray-400 dark:bg-gray-600";
                        cell.dataset.row = r;
                        cell.dataset.col = c;

                        cell.addEventListener("click", onClick);
                        cell.addEventListener("contextmenu", onRightClick);

                        game.appendChild(cell);
                    }
                }
            }

            function revealAllBombs() {
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        const cell = board[r][c];
                        if (!cell.bomb) continue;

                        const el = document.querySelector(`[data-row='${r}'][data-col='${c}']`);
                        if (!el) continue;

                        el.textContent = "ðŸ’£";
                        el.className =
                            `w-[30px] h-[30px] flex items-center justify-center text-sm font-bold bg-red-200 dark:bg-red-900 cursor-default ${cell.flagged ? "ring-2 ring-yellow-400" : ""}`;
                    }
                }
            }

            function reveal(r, c) {
                const cell = board[r][c];
                if (cell.revealed || cell.flagged) return;

                const el = document.querySelector(`[data-row='${r}'][data-col='${c}']`);
                cell.revealed = true;
                revealedCount++;

                el.className =
                    "w-[30px] h-[30px] flex items-center justify-center text-sm font-bold bg-gray-200 dark:bg-gray-800 cursor-default";

                if (cell.bomb) {
                    el.textContent = "ðŸ’£";
                } else if (cell.adjacent > 0) {
                    el.textContent = cell.adjacent;
                }

                if (!cell.bomb && cell.adjacent === 0) {
                    for (let dr = -1; dr <= 1; dr++) {
                        for (let dc = -1; dc <= 1; dc++) {
                            const nr = r + dr;
                            const nc = c + dc;
                            if (inBounds(nr, nc)) reveal(nr, nc);
                        }
                    }
                }
            }

            function onClick(e) {
                if (gameOver) return;

                const r = +e.target.dataset.row;
                const c = +e.target.dataset.col;
                const cell = board[r][c];

                if (!timerInterval) startTimer();

                if (cell.bomb) {
                    reveal(r, c);
                    revealAllBombs();

                    const hitCell = document.querySelector(`[data-row='${r}'][data-col='${c}']`);
                    if (hitCell) {
                        hitCell.classList.add("bomb-hit");
                    }

                    const gameEl = document.getElementById("game");
                    if (gameEl) {
                        gameEl.classList.add("board-shake");
                        setTimeout(() => {
                            gameEl.classList.remove("board-shake");
                        }, 500);
                    }

                    const crackOverlay = document.getElementById("crackOverlay");
                    if (crackOverlay) {
                        crackOverlay.classList.remove("active");
                        // Force reflow so animation can restart on subsequent games
                        void crackOverlay.offsetWidth;
                        crackOverlay.classList.add("active");
                    }

                    gameOver = true;
                    stopTimer();
                    document.getElementById("message").textContent = "Game Over";
                    return;
                }

                reveal(r, c);

                if (revealedCount === totalSafe) {
                    gameOver = true;
                    stopTimer();
                    document.getElementById("message").textContent = "You Win!";
                }
            }

            function onRightClick(e) {
                e.preventDefault();
                if (gameOver) return;

                const r = +e.target.dataset.row;
                const c = +e.target.dataset.col;
                const cell = board[r][c];
                if (cell.revealed) return;

                cell.flagged = !cell.flagged;
                e.target.textContent = cell.flagged ? "ðŸš©" : "";
                flagsCount += cell.flagged ? 1 : -1;
                updateBombCounter();
            }

            function initGame() {

                ROWS = +document.getElementById('rowsInput').value;
                COLS = +document.getElementById('colsInput').value;
                BOMB_PROB = parseFloat(document.getElementById('complexitySelect').value);

                board = [];
                totalBombs = 0;
                revealedCount = 0;
                flagsCount = 0;
                gameOver = false;
                resetTimer();
                document.getElementById("message").textContent = "";

                for (let r = 0; r < ROWS; r++) {
                    const row = [];
                    for (let c = 0; c < COLS; c++) {
                        const bomb = Math.random() < BOMB_PROB;
                        if (bomb) totalBombs++;
                        row.push({ bomb, revealed: false, flagged: false, adjacent: 0 });
                    }
                    board.push(row);
                }

                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        if (!board[r][c].bomb) {
                            board[r][c].adjacent = countAdjacent(r, c);
                        }
                    }
                }

                totalSafe = ROWS * COLS - totalBombs;
                updateBombCounter();
                renderBoard();

            }

            function resetToDefaults() {
                document.getElementById('rowsInput').value = String(DEFAULT_ROWS);
                document.getElementById('colsInput').value = String(DEFAULT_COLS);
                document.getElementById('complexitySelect').value = String(DEFAULT_BOMB_PROB);
                initGame();
            }

            function setTheme(theme) {
                const isDark = theme === "dark";
                if (isDark) {
                    document.documentElement.classList.add("dark");
                } else {
                    document.documentElement.classList.remove("dark");
                }
                localStorage.setItem("theme", theme);

                const toggle = document.getElementById("themeToggle");
                const thumb = document.getElementById("themeToggleThumb");
                if (toggle && thumb) {
                    toggle.setAttribute("aria-checked", String(isDark));
                    thumb.classList.toggle("translate-x-1", !isDark);
                    thumb.classList.toggle("translate-x-7", isDark);
                }
            }

            function toggleTheme() {
                const isDark = document.documentElement.classList.contains("dark");
                setTheme(isDark ? "light" : "dark");
            }

            const restartBtn = document.getElementById("restartBtn");
            if (restartBtn) {
                restartBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    initGame();
                });
            }

            const resetBtn = document.getElementById("resetBtn");
            if (resetBtn) {
                resetBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    resetToDefaults();
                });
            }

            const themeToggle = document.getElementById("themeToggle");
            if (themeToggle) {
                themeToggle.addEventListener("click", (e) => {
                    e.preventDefault();
                    toggleTheme();
                });
            }

            setTheme(localStorage.getItem("theme") || "dark");
            initGame();

        });
    </script>
</body>

</html>
